name: Build Windows Binaries with HEVC

on:
  workflow_dispatch:
    inputs:
      variant:
        description: 'Build variant (vips-web or vips-all)'
        required: true
        default: 'vips-web'
        type: choice
        options:
          - vips-web
          - vips-all
      with_hevc:
        description: 'Build with HEVC support'
        required: false
        default: false
        type: boolean
      target:
        description: 'Specific target (leave empty for all)'
        required: false
        default: ''
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: libvips/build-win64-mxe
          path: build-win64-mxe

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Patch x265 HEVC plugin test source
        if: ${{ inputs.with_hevc }}
        working-directory: build-win64-mxe
        run: |
          set -euo pipefail
          mkdir -p build/plugins/hevc-deps/src
          cat > build/plugins/hevc-deps/src/x265-test.c <<'EOF'
          #include <x265.h>
          
          int main(void) {
            const x265_api *api = x265_api_get(8);
            return api ? 0 : 1;
          }
          EOF
          
          python3 - <<'PY'
          from pathlib import Path
          
          mk = Path("build/plugins/hevc-deps/x265.mk")
          s = mk.read_text(encoding="utf-8")
          s2 = s.replace(
              "'$(TOP_DIR)/src/$(PKG)-test.c'",
              "'/data/plugins/hevc-deps/src/$(PKG)-test.c'",
          )
          if s == s2:
            print("x265.mk did not reference $(TOP_DIR)/src/$(PKG)-test.c; skipping patch.")
          else:
            mk.write_text(s2, encoding="utf-8")
            print("Patched x265.mk to compile test from plugin src/")
          PY

      - name: Patch cfitsio download URL (avoid flaky upstream)
        working-directory: build-win64-mxe
        run: |
          set -euo pipefail
          
          python3 - <<'PY'
          from pathlib import Path
          import re
          
          TARGET_VERSION = "4.6.2"
          CODELOAD_URL = "https://codeload.github.com/HEASARC/cfitsio/tar.gz/refs/tags/cfitsio-$(cfitsio_VERSION)"
          CODELOAD_SUBDIR = "cfitsio-cfitsio-$(cfitsio_VERSION)"
          CODELOAD_SHA256 = "83f710f9441e7c703eeb485c9a475f50801ae7fad32ac7e356a406d318b4c02f"
          
          candidates = list(Path(".").rglob("*.mk"))
          touched = []
          
          for mk in candidates:
            s = mk.read_text(encoding="utf-8")
            if "cfitsio_" not in s:
              continue
          
            m = re.search(r"^cfitsio_VERSION\\s*[:+]?=\\s*([^\\s]+)\\s*$", s, flags=re.M)
            if not m or m.group(1) != TARGET_VERSION:
              continue
          
            s2 = s
            # Update URL to stable codeload endpoint (regardless of current host)
            s2 = re.sub(
              r"^cfitsio_URL\\s*[:+]?=\\s*.*$",
              f"cfitsio_URL      := {CODELOAD_URL}",
              s2,
              flags=re.M,
            )
            # Ensure the extracted directory name matches codeload's root folder
            s2 = re.sub(
              r"^cfitsio_SUBDIR\\s*[:+]?=\\s*.*$",
              f"cfitsio_SUBDIR   := {CODELOAD_SUBDIR}",
              s2,
              flags=re.M,
            )
            # Pin checksum for the codeload tarball
            s2 = re.sub(
              r"^cfitsio_CHECKSUM\\s*[:+]?=\\s*[0-9a-f]{64}\\s*$",
              f"cfitsio_CHECKSUM := {CODELOAD_SHA256}",
              s2,
              flags=re.M,
            )
          
            if s2 != s:
              mk.write_text(s2, encoding="utf-8")
              touched.append(str(mk))
          
          if touched:
            print("Patched cfitsio download settings in:")
            for p in touched:
              print(f" - {p}")
          else:
            print("No cfitsio 4.6.2 definitions found to patch; continuing.")
          PY

      - name: Build Windows binaries
        working-directory: build-win64-mxe
        run: |
          chmod +x build.sh
          
          # Build command with optional flags
          BUILD_CMD="./build.sh"
          
          if [ "${{ inputs.with_hevc }}" = "true" ]; then
            BUILD_CMD="$BUILD_CMD --with-hevc"
          fi
          
          if [ -n "${{ inputs.target }}" ]; then
            BUILD_CMD="$BUILD_CMD --target ${{ inputs.target }}"
          fi
          
          BUILD_CMD="$BUILD_CMD ${{ inputs.variant }}"
          
          echo "Running: $BUILD_CMD"
          $BUILD_CMD

      - name: List built artifacts
        working-directory: build-win64-mxe
        run: |
          echo "Built artifacts:"
          ls -lh packaging/*.zip || echo "No zip files found"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries-${{ inputs.variant }}-${{ inputs.with_hevc && 'hevc' || 'no-hevc' }}
          path: build-win64-mxe/packaging/*.zip
          retention-days: 30
          if-no-files-found: error
