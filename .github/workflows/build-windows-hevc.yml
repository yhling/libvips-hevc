name: Build Windows Binaries with HEVC

on:
  workflow_dispatch:
    inputs:
      variant:
        description: 'Build variant (vips-web or vips-all)'
        required: true
        default: 'vips-web'
        type: choice
        options:
          - vips-web
          - vips-all
      with_hevc:
        description: 'Build with HEVC support'
        required: false
        default: false
        type: boolean
      target:
        description: 'Specific target (leave empty for all)'
        required: false
        default: ''
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: libvips/build-win64-mxe
          path: build-win64-mxe

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Patch x265 build to fix missing test file
        working-directory: build-win64-mxe
        if: inputs.with_hevc == true
        run: |
          # Patch MXE x265 package file to remove x265-test.c compilation
          # The x265-test.c file doesn't exist and causes build failures
          # This patch removes or comments out the test compilation step
          
          # Check if MXE source directory exists (it might be in the container)
          # Try to patch any x265-related build files we can find
          echo "Searching for x265 build files to patch..."
          
          # Look for x265 package files in common locations
          for x265_file in \
            "mxe/src/x265.mk" \
            "src/x265.mk" \
            "plugins/hevc-deps/x265.mk" \
            "plugins/hevc-deps/build.sh"; do
            if [ -f "$x265_file" ]; then
              echo "Found x265 file: $x265_file"
              if grep -q "x265-test.c" "$x265_file" 2>/dev/null; then
                echo "Patching $x265_file to remove x265-test.c reference"
                # Create backup
                cp "$x265_file" "$x265_file.bak"
                # Remove lines containing x265-test.c
                sed -i '/x265-test\.c/d' "$x265_file" || true
                # Remove references in command lines
                sed -i 's|\./src/x265-test\.c||g' "$x265_file" || true
                sed -i 's|src/x265-test\.c||g' "$x265_file" || true
              fi
            fi
          done
          
          # Also search recursively for any files that might reference it
          if [ -d "plugins/hevc-deps" ]; then
            echo "Searching in plugins/hevc-deps..."
            find plugins/hevc-deps -type f \( -name "*.mk" -o -name "*.sh" -o -name "*.cmake" \) -exec grep -l "x265-test" {} \; 2>/dev/null | while read file; do
              echo "Patching $file"
              sed -i.bak '/x265-test\.c/d' "$file" || true
              sed -i.bak 's|\./src/x265-test\.c||g' "$file" || true
            done
          fi
          
          echo "Patch complete. If files were found and patched, the build should proceed."
          echo "Note: If the error persists, the x265 package file may be inside the Docker container."
          echo "In that case, you may need to fork libvips/build-win64-mxe and fix the x265 package definition there."

      - name: Build Windows binaries
        working-directory: build-win64-mxe
        run: |
          chmod +x build.sh
          
          # Build command with optional flags
          BUILD_CMD="./build.sh"
          
          if [ "${{ inputs.with_hevc }}" = "true" ]; then
            BUILD_CMD="$BUILD_CMD --with-hevc"
          fi
          
          if [ -n "${{ inputs.target }}" ]; then
            BUILD_CMD="$BUILD_CMD --target ${{ inputs.target }}"
          fi
          
          BUILD_CMD="$BUILD_CMD ${{ inputs.variant }}"
          
          echo "Running: $BUILD_CMD"
          $BUILD_CMD

      - name: List built artifacts
        working-directory: build-win64-mxe
        run: |
          echo "Built artifacts:"
          ls -lh packaging/*.zip || echo "No zip files found"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries-${{ inputs.variant }}-${{ inputs.with_hevc && 'hevc' || 'no-hevc' }}
          path: build-win64-mxe/packaging/*.zip
          retention-days: 30
          if-no-files-found: error
