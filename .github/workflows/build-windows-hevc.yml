name: Build Windows Binaries with HEVC

on:
  workflow_dispatch:
    inputs:
      variant:
        description: 'Build variant (vips-web or vips-all)'
        required: true
        default: 'vips-web'
        type: choice
        options:
          - vips-web
          - vips-all
      with_hevc:
        description: 'Build with HEVC support'
        required: false
        default: false
        type: boolean
      target:
        description: 'Specific target (leave empty for all)'
        required: false
        default: ''
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: libvips/build-win64-mxe
          path: build-win64-mxe

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Patch x265 HEVC plugin test source
        if: ${{ inputs.with_hevc }}
        working-directory: build-win64-mxe
        run: |
          set -euo pipefail
          mkdir -p build/plugins/hevc-deps/src
          cat > build/plugins/hevc-deps/src/x265-test.c <<'EOF'
          #include <x265.h>
          
          int main(void) {
            const x265_api *api = x265_api_get(8);
            return api ? 0 : 1;
          }
          EOF
          
          python3 - <<'PY'
          from pathlib import Path
          
          mk = Path("build/plugins/hevc-deps/x265.mk")
          s = mk.read_text(encoding="utf-8")
          s2 = s.replace(
              "'$(TOP_DIR)/src/$(PKG)-test.c'",
              "'/data/plugins/hevc-deps/src/$(PKG)-test.c'",
          )
          if s == s2:
            raise SystemExit("Expected x265.mk to reference $(TOP_DIR)/src/$(PKG)-test.c, but it did not.")
          mk.write_text(s2, encoding="utf-8")
          PY

      - name: Patch cfitsio download URL (avoid flaky upstream)
        working-directory: build-win64-mxe
        run: |
          set -euo pipefail
          
          python3 - <<'PY'
          from pathlib import Path
          import re
          
          mk = Path("build/overrides.mk")
          s = mk.read_text(encoding="utf-8")
          
          # Use GitHub codeload for a stable download path.
          # This tarball expands to: cfitsio-cfitsio-<version>/
          s2 = s
          s2 = re.sub(r"^cfitsio_CHECKSUM\\s*:=\\s*[0-9a-f]{64}\\s*$",
                      "cfitsio_CHECKSUM := 83f710f9441e7c703eeb485c9a475f50801ae7fad32ac7e356a406d318b4c02f",
                      s2, flags=re.M)
          s2 = re.sub(r"^cfitsio_SUBDIR\\s*:=\\s*cfitsio-\\$\\(cfitsio_VERSION\\)\\s*$",
                      "cfitsio_SUBDIR   := cfitsio-cfitsio-$(cfitsio_VERSION)",
                      s2, flags=re.M)
          s2 = re.sub(r"^cfitsio_URL\\s*:=\\s*https://heasarc\\.gsfc\\.nasa\\.gov/FTP/software/fitsio/c/\\$\\(cfitsio_FILE\\)\\s*$",
                      "cfitsio_URL      := https://codeload.github.com/HEASARC/cfitsio/tar.gz/refs/tags/cfitsio-$(cfitsio_VERSION)",
                      s2, flags=re.M)
          
          if s2 == s:
            raise SystemExit("Expected to patch cfitsio_* variables in build/overrides.mk, but no changes were made.")
          
          mk.write_text(s2, encoding="utf-8")
          PY

      - name: Build Windows binaries
        working-directory: build-win64-mxe
        run: |
          chmod +x build.sh
          
          # Build command with optional flags
          BUILD_CMD="./build.sh"
          
          if [ "${{ inputs.with_hevc }}" = "true" ]; then
            BUILD_CMD="$BUILD_CMD --with-hevc"
          fi
          
          if [ -n "${{ inputs.target }}" ]; then
            BUILD_CMD="$BUILD_CMD --target ${{ inputs.target }}"
          fi
          
          BUILD_CMD="$BUILD_CMD ${{ inputs.variant }}"
          
          echo "Running: $BUILD_CMD"
          $BUILD_CMD

      - name: List built artifacts
        working-directory: build-win64-mxe
        run: |
          echo "Built artifacts:"
          ls -lh packaging/*.zip || echo "No zip files found"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries-${{ inputs.variant }}-${{ inputs.with_hevc && 'hevc' || 'no-hevc' }}
          path: build-win64-mxe/packaging/*.zip
          retention-days: 30
          if-no-files-found: error
