name: Build Windows Binaries with HEVC

on:
  workflow_dispatch:
    inputs:
      variant:
        description: 'Build variant (vips-web or vips-all)'
        required: true
        default: 'vips-web'
        type: choice
        options:
          - vips-web
          - vips-all
      with_hevc:
        description: 'Build with HEVC support'
        required: false
        default: false
        type: boolean
      target:
        description: 'Specific target (leave empty for all)'
        required: false
        default: ''
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Build each MXE target in its own job to avoid exhausting runner disk
        # when building all targets in a single container image.
        target: ${{ fromJson(inputs.target != '' && format('["{0}"]', inputs.target) || '["x86_64-w64-mingw32.shared","x86_64-w64-mingw32.static","i686-w64-mingw32.shared","i686-w64-mingw32.static","aarch64-w64-mingw32.shared","aarch64-w64-mingw32.static"]') }}
    permissions:
      contents: read
      packages: read
      actions: write
    env:
      # Used by our runtime patch to enable Docker Buildx GHA layer caching.
      # Include inputs so caches don't cross-contaminate different build matrices.
      BUILDX_CACHE_SCOPE: libvips-build-win64-mxe-${{ inputs.variant }}-${{ inputs.with_hevc && 'hevc' || 'no-hevc' }}-${{ matrix.target }}

    steps:
      - name: Free disk space on runner
        run: |
          set -euo pipefail
          df -h
          # Remove large preinstalled SDKs/toolchains we don't use in this build.
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android /usr/local/share/boost || true
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true
          # Best-effort prune (may be unused depending on engine).
          sudo docker system prune -af || true
          sudo podman system prune -af || true
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: libvips/build-win64-mxe
          path: build-win64-mxe

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Patch build.sh (remove contains_gpl_libs checks)
        working-directory: build-win64-mxe
        run: |
          set -euo pipefail
          python3 - <<'PY'
          from pathlib import Path
          import re

          p = Path("build.sh")
          s = p.read_text(encoding="utf-8")
          orig = s

          # 1) Remove the contains_gpl_libs assignment line
          s = re.sub(
              r'^\[ "\$with_hevc" = true \] && contains_gpl_libs=.*\n',
              "",
              s,
              flags=re.M,
          )

          # 2) Remove contains_gpl_libs from default target selection.
          #    Keep the --with-ffi-compat behaviour; otherwise default to both shared+static.
          s = re.sub(
              r'if \[ \${#mxe_targets\[@\]} -eq 0 \]; then\n'
              r'  if \[ "\$contains_gpl_libs" = true \]; then\n'
              r'(?:.|\n)*?'
              r'  fi\n'
              r'fi\n',
              "if [ ${#mxe_targets[@]} -eq 0 ]; then\n"
              "  if [ \"$with_ffi_compat\" = true ]; then\n"
              "    # Omit shared builds by default for the --with-ffi-compat option\n"
              "    mxe_targets=({x86_64,i686,aarch64}-w64-mingw32.static)\n"
              "  else\n"
              "    # Default to all possible targets otherwise\n"
              "    mxe_targets=({x86_64,i686,aarch64}-w64-mingw32.{shared,static})\n"
              "  fi\n"
              "fi\n",
              s,
          )

          # 3) Remove the hard error that blocks static targets when contains_gpl_libs is true
          s = re.sub(
              r'if \[ "\$targets_static" = true \] && \[ "\$contains_gpl_libs" = true \]; then\n'
              r'(?:.|\n)*?'
              r'fi\n',
              "",
              s,
          )

          if s == orig:
              print("No contains_gpl_libs sections found to patch in build.sh; continuing.")
          else:
              p.write_text(s, encoding="utf-8")
              print("Patched build.sh to remove contains_gpl_libs checks.")

          # If build.sh still references contains_gpl_libs, fail fast so we don't silently keep gating.
          if "contains_gpl_libs" in p.read_text(encoding="utf-8"):
              raise SystemExit("build.sh still contains 'contains_gpl_libs' after patch; refusing to continue.")
          PY

      - name: Patch x265 HEVC plugin test source
        if: ${{ inputs.with_hevc }}
        working-directory: build-win64-mxe
        run: |
          set -euo pipefail
          mkdir -p build/plugins/hevc-deps/src
          cat > build/plugins/hevc-deps/src/x265-test.c <<'EOF'
          #include <x265.h>
          
          int main(void) {
            const x265_api *api = x265_api_get(8);
            return api ? 0 : 1;
          }
          EOF
          
          python3 - <<'PY'
          from pathlib import Path
          
          mk = Path("build/plugins/hevc-deps/x265.mk")
          s = mk.read_text(encoding="utf-8")
          s2 = s.replace(
              "'$(TOP_DIR)/src/$(PKG)-test.c'",
              "'/data/plugins/hevc-deps/src/$(PKG)-test.c'",
          )
          if s == s2:
            print("x265.mk did not reference $(TOP_DIR)/src/$(PKG)-test.c; skipping patch.")
          else:
            mk.write_text(s2, encoding="utf-8")
            print("Patched x265.mk to compile test from plugin src/")
          PY

      - name: Patch vips-web plugin for HEVC (enable heif module + record x265 versions)
        if: ${{ inputs.with_hevc && inputs.variant == 'vips-web' }}
        working-directory: build-win64-mxe
        run: |
          set -euo pipefail
          python3 - <<'PY'
          from pathlib import Path
          import re
          
          # 1) Ensure the vips-web build can enable the HEIF module when --with-hevc is used.
          # Upstream uses modules + heif-module to isolate HEVC/GPL bits.
          overrides = Path("build/plugins/web-deps/overrides.mk")
          s = overrides.read_text(encoding="utf-8")
          orig = s
          s = s.replace(
              "vips_MESON_OPTS = \\\n"
              "    -Dmodules=disabled \\\n",
              "vips_MESON_OPTS = \\\n"
              "    -Dmodules=$(if $(IS_HEVC),enabled,disabled) \\\n"
              "    -Dheif-module=$(if $(IS_HEVC),enabled,disabled) \\\n",
          )
          if s == orig:
            raise SystemExit("Unexpected format in build/plugins/web-deps/overrides.mk; refusing to patch.")
          overrides.write_text(s, encoding="utf-8")
          print("Patched web-deps/overrides.mk to enable modules+heif-module when IS_HEVC is set.")
          
          # 2) Record HEVC dependency versions in vips-web's versions.json, matching vips-all behaviour.
          vips_web = Path("build/plugins/web-deps/vips-web.mk")
          s = vips_web.read_text(encoding="utf-8")
          if '"de265":' not in s:
            s2 = s.replace(
                "     printf '  \"cgif\": \"$(cgif_VERSION)\",\\n'; \\\n",
                "     printf '  \"cgif\": \"$(cgif_VERSION)\",\\n'; \\\n"
                "     $(if $(IS_HEVC),printf '  \"de265\": \"$(libde265_VERSION)\"$(comma)\\n';) \\\n",
            )
            if s2 == s:
              raise SystemExit("Unexpected format in build/plugins/web-deps/vips-web.mk; could not insert de265 version line.")
            s = s2

          if '"x265":' not in s:
            s2 = s.replace(
                "     printf '  \"webp\": \"$(libwebp_VERSION)\",\\n'; \\\n",
                "     printf '  \"webp\": \"$(libwebp_VERSION)\",\\n'; \\\n"
                "     $(if $(IS_HEVC),printf '  \"x265\": \"$(x265_VERSION)\"$(comma)\\n';) \\\n",
            )
            if s2 == s:
              raise SystemExit("Unexpected format in build/plugins/web-deps/vips-web.mk; could not insert x265 version line.")
            s = s2
          vips_web.write_text(s, encoding="utf-8")
          print("Patched web-deps/vips-web.mk to include libde265/x265 in versions.json when IS_HEVC is set.")
          PY

      - name: Patch libheif for libde265 static builds (avoid dllimport)
        if: ${{ inputs.with_hevc }}
        working-directory: build-win64-mxe
        run: |
          set -euo pipefail
          python3 - <<'PY'
          from pathlib import Path
          import re

          p = Path("build/libheif.mk")
          s = p.read_text(encoding="utf-8")

          marker = "LIBDE265_STATIC_BUILD"
          if marker in s:
            print("build/libheif.mk already handles LIBDE265_STATIC_BUILD; skipping patch.")
            raise SystemExit(0)

          # libde265's public header uses __declspec(dllimport) on Windows unless
          # LIBDE265_STATIC_BUILD is defined. For MXE *.static targets, we link
          # against libde265.a, so we must ensure consumers compile without dllimport.
          #
          # Reference: libde265/libde265/de265.h
          needle = "$(eval export CXXFLAGS += -O3)\n"
          if needle not in s:
            raise SystemExit("Unexpected format in build/libheif.mk; refusing to patch.")

          insert = needle + (
            "\n"
            "    # For static Windows builds, ensure libde265 symbols are not marked dllimport.\n"
            "    $(if $(and $(IS_HEVC),$(BUILD_STATIC)), $(eval export CXXFLAGS += -DLIBDE265_STATIC_BUILD))\n"
          )

          s2 = s.replace(needle, insert, 1)
          p.write_text(s2, encoding="utf-8")
          print("Patched build/libheif.mk to define LIBDE265_STATIC_BUILD for HEVC+static targets.")
          PY

      - name: Patch cfitsio download URL (avoid flaky upstream)
        run: |
          set -euo pipefail

          python3 - <<'PY'
          from pathlib import Path

          target = Path("build-win64-mxe/build/overrides.mk")
          if not target.exists():
            raise SystemExit(f"Expected file not found: {target}")

          lines = target.read_text(encoding="utf-8").splitlines(keepends=True)
          out = []

          for line in lines:
            if ("cfitsio_URL" in line) or ("cfitsio_CHECKSUM" in line):
              if not line.startswith("#"):
                line = "#" + line
            out.append(line)

          text = "".join(out)

          # Append pinned definitions EXACTLY to the bottom of the file.
          text += '\ncfitsio_URL      := https://codeload.github.com/HEASARC/cfitsio/tar.gz/refs/tags/cfitsio-$(cfitsio_VERSION)\n'
          text += 'cfitsio_CHECKSUM := 83f710f9441e7c703eeb485c9a475f50801ae7fad32ac7e356a406d318b4c02f\n\n'
          # GitHub codeload archives extract to "<repo>-<tag>/" rather than "cfitsio-<version>/".
          # MXE's default expects "$(PKG)-$(VERSION)", so override the subdir name to match.
          text += 'cfitsio_SUBDIR   := cfitsio-cfitsio-$(cfitsio_VERSION)\n\n'

          target.write_text(text, encoding="utf-8")

          # Print out the file.
          print(target.read_text(encoding="utf-8"), end="")
          PY

      - name: Patch ImageMagick for static libxml2 (LIBXML_STATIC)
        run: |
          set -euo pipefail

          python3 - <<'PY'
          from pathlib import Path
          import re

          target = Path("build-win64-mxe/build/overrides.mk")
          if not target.exists():
            raise SystemExit(f"Expected file not found: {target}")

          s = target.read_text(encoding="utf-8")
          m = re.search(r"define imagemagick_BUILD\n(?P<body>[\s\S]*?)\nendef\n", s)
          if not m:
            raise SystemExit("Could not find 'define imagemagick_BUILD' block in build/overrides.mk")

          body = m.group("body")
          if "LIBXML_STATIC" in body:
            print("imagemagick_BUILD already sets LIBXML_STATIC; skipping patch.")
            raise SystemExit(0)

          needle = "        $(PKG_CONFIGURE_OPTS)\n"
          if needle not in body:
            raise SystemExit("Unexpected imagemagick_BUILD format: missing $(PKG_CONFIGURE_OPTS) line")

          body2 = body.replace(
            needle,
            "        $(PKG_CONFIGURE_OPTS) \\\n"
            "        $(if $(BUILD_STATIC), CFLAGS='$(CFLAGS) -DLIBXML_STATIC')\n",
            1,
          )

          s2 = s[:m.start("body")] + body2 + s[m.end("body"):]
          target.write_text(s2, encoding="utf-8")
          print("Patched imagemagick_BUILD to define LIBXML_STATIC for static builds.")
          PY

      - name: Build Windows binaries
        working-directory: build-win64-mxe
        run: |
          chmod +x build.sh
          
          # Build command with optional flags
          BUILD_CMD="./build.sh"
          
          if [ "${{ inputs.with_hevc }}" = "true" ]; then
            BUILD_CMD="$BUILD_CMD --with-hevc"
          fi
 
          # Always build exactly one target per job (matrix.target).
          BUILD_CMD="$BUILD_CMD --target ${{ matrix.target }}"
          
          BUILD_CMD="$BUILD_CMD ${{ inputs.variant }}"
          
          echo "Running: $BUILD_CMD"
          $BUILD_CMD

      - name: List built artifacts
        working-directory: build-win64-mxe
        run: |
          echo "Built artifacts:"
          ls -lh packaging/*.zip || echo "No zip files found"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries-${{ inputs.variant }}-${{ inputs.with_hevc && 'hevc' || 'no-hevc' }}-${{ matrix.target }}
          path: build-win64-mxe/packaging/*.zip
          retention-days: 30
          if-no-files-found: error
