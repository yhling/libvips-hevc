name: Build Windows Binaries with HEVC

on:
  workflow_dispatch:
    inputs:
      variant:
        description: 'Build variant (vips-web or vips-all)'
        required: true
        default: 'vips-web'
        type: choice
        options:
          - vips-web
          - vips-all
      with_hevc:
        description: 'Build with HEVC support'
        required: false
        default: false
        type: boolean
      target:
        description: 'Specific target (leave empty for all)'
        required: false
        default: ''
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      actions: write
    env:
      # Used by our runtime patch to enable Docker Buildx GHA layer caching.
      # Include inputs so caches don't cross-contaminate different build matrices.
      BUILDX_CACHE_SCOPE: libvips-build-win64-mxe-${{ inputs.variant }}-${{ inputs.with_hevc && 'hevc' || 'no-hevc' }}-${{ inputs.target != '' && inputs.target || 'all-targets' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: libvips/build-win64-mxe
          path: build-win64-mxe

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Patch build.sh (enable Docker Buildx layer caching)
        working-directory: build-win64-mxe
        run: |
          set -euo pipefail
          python3 - <<'PY'
          from pathlib import Path
          import re

          p = Path("build.sh")
          s = p.read_text(encoding="utf-8")
          orig = s

          # Replace the single "$oci_runtime build \\" invocation that builds libvips-build-win-mxe
          # with a Docker Buildx build that uses GitHub Actions cache (type=gha).
          #
          # This keeps podman support intact (falls back to "$oci_runtime build ...").
          pattern = re.compile(
              r"""(?mx)
              ^#\ Build\ requested\ packages\s*\n
              ^\$oci_runtime\ build\s*\\\n
              (?:.*\n)*?
              ^\s*build\s*\n
              """,
          )

          replacement = """# Build requested packages
          if [ "$oci_runtime" = docker ] && docker buildx version >/dev/null 2>&1; then
            docker buildx build \\
              --pull=$with_prebuilt \\
              --cache-from "type=gha,scope=${BUILDX_CACHE_SCOPE:-libvips-build-win-mxe}" \\
              --cache-to "type=gha,mode=max,scope=${BUILDX_CACHE_SCOPE:-libvips-build-win-mxe}" \\
              --load \\
              -t libvips-build-win-mxe \\
              -f container/Dockerfile \\
              --build-arg BASE_IMAGE="$image" \\
              --build-arg PKGS="${pkgs[*]}" \\
              --build-arg MXE_TARGETS="${mxe_targets[*]}" \\
              --build-arg DEBUG="$with_debug" \\
              --build-arg PLUGIN_DIRS="$plugin_dirs" \\
              --build-arg GIT_COMMIT="$git_commit" \\
              build
          else
            $oci_runtime build \\
              --pull=$with_prebuilt \\
              -t libvips-build-win-mxe \\
              -f container/Dockerfile \\
              --build-arg BASE_IMAGE="$image" \\
              --build-arg PKGS="${pkgs[*]}" \\
              --build-arg MXE_TARGETS="${mxe_targets[*]}" \\
              --build-arg DEBUG="$with_debug" \\
              --build-arg PLUGIN_DIRS="$plugin_dirs" \\
              --build-arg GIT_COMMIT="$git_commit" \\
              build
          fi
          """

          s2, n = pattern.subn(replacement, s, count=1)
          if n != 1:
            raise SystemExit(f"Expected to patch exactly one build invocation, patched: {n}")

          p.write_text(s2, encoding="utf-8")
          print("Patched build.sh to use docker buildx build with GHA cache (when docker is available).")
          PY

      - name: Patch x265 HEVC plugin test source
        if: ${{ inputs.with_hevc }}
        working-directory: build-win64-mxe
        run: |
          set -euo pipefail
          mkdir -p build/plugins/hevc-deps/src
          cat > build/plugins/hevc-deps/src/x265-test.c <<'EOF'
          #include <x265.h>
          
          int main(void) {
            const x265_api *api = x265_api_get(8);
            return api ? 0 : 1;
          }
          EOF
          
          python3 - <<'PY'
          from pathlib import Path
          
          mk = Path("build/plugins/hevc-deps/x265.mk")
          s = mk.read_text(encoding="utf-8")
          s2 = s.replace(
              "'$(TOP_DIR)/src/$(PKG)-test.c'",
              "'/data/plugins/hevc-deps/src/$(PKG)-test.c'",
          )
          if s == s2:
            print("x265.mk did not reference $(TOP_DIR)/src/$(PKG)-test.c; skipping patch.")
          else:
            mk.write_text(s2, encoding="utf-8")
            print("Patched x265.mk to compile test from plugin src/")
          PY

      - name: Patch vips-web plugin for HEVC (enable heif module + record x265 versions)
        if: ${{ inputs.with_hevc && inputs.variant == 'vips-web' }}
        working-directory: build-win64-mxe
        run: |
          set -euo pipefail
          python3 - <<'PY'
          from pathlib import Path
          import re
          
          # 1) Ensure the vips-web build can enable the HEIF module when --with-hevc is used.
          # Upstream uses modules + heif-module to isolate HEVC/GPL bits.
          overrides = Path("build/plugins/web-deps/overrides.mk")
          s = overrides.read_text(encoding="utf-8")
          orig = s
          s = s.replace(
              "vips_MESON_OPTS = \\\n"
              "    -Dmodules=disabled \\\n",
              "vips_MESON_OPTS = \\\n"
              "    -Dmodules=$(if $(IS_HEVC),enabled,disabled) \\\n"
              "    -Dheif-module=$(if $(IS_HEVC),enabled,disabled) \\\n",
          )
          if s == orig:
            raise SystemExit("Unexpected format in build/plugins/web-deps/overrides.mk; refusing to patch.")
          overrides.write_text(s, encoding="utf-8")
          print("Patched web-deps/overrides.mk to enable modules+heif-module when IS_HEVC is set.")
          
          # 2) Record HEVC dependency versions in vips-web's versions.json, matching vips-all behaviour.
          vips_web = Path("build/plugins/web-deps/vips-web.mk")
          s = vips_web.read_text(encoding="utf-8")
          if '"de265":' not in s:
            s2 = s.replace(
                "     printf '  \"cgif\": \"$(cgif_VERSION)\",\\n'; \\\n",
                "     printf '  \"cgif\": \"$(cgif_VERSION)\",\\n'; \\\n"
                "     $(if $(IS_HEVC),printf '  \"de265\": \"$(libde265_VERSION)\"$(comma)\\n';) \\\n",
            )
            if s2 == s:
              raise SystemExit("Unexpected format in build/plugins/web-deps/vips-web.mk; could not insert de265 version line.")
            s = s2

          if '"x265":' not in s:
            s2 = s.replace(
                "     printf '  \"webp\": \"$(libwebp_VERSION)\",\\n'; \\\n",
                "     printf '  \"webp\": \"$(libwebp_VERSION)\",\\n'; \\\n"
                "     $(if $(IS_HEVC),printf '  \"x265\": \"$(x265_VERSION)\"$(comma)\\n';) \\\n",
            )
            if s2 == s:
              raise SystemExit("Unexpected format in build/plugins/web-deps/vips-web.mk; could not insert x265 version line.")
            s = s2
          vips_web.write_text(s, encoding="utf-8")
          print("Patched web-deps/vips-web.mk to include libde265/x265 in versions.json when IS_HEVC is set.")
          PY

      - name: Build Windows binaries
        working-directory: build-win64-mxe
        run: |
          chmod +x build.sh
          
          # Build command with optional flags
          BUILD_CMD="./build.sh"
          
          if [ "${{ inputs.with_hevc }}" = "true" ]; then
            BUILD_CMD="$BUILD_CMD --with-hevc"
          fi
          
          if [ -n "${{ inputs.target }}" ]; then
            BUILD_CMD="$BUILD_CMD --target ${{ inputs.target }}"
          fi
          
          BUILD_CMD="$BUILD_CMD ${{ inputs.variant }}"
          
          echo "Running: $BUILD_CMD"
          $BUILD_CMD

      - name: List built artifacts
        working-directory: build-win64-mxe
        run: |
          echo "Built artifacts:"
          ls -lh packaging/*.zip || echo "No zip files found"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries-${{ inputs.variant }}-${{ inputs.with_hevc && 'hevc' || 'no-hevc' }}
          path: build-win64-mxe/packaging/*.zip
          retention-days: 30
          if-no-files-found: error
