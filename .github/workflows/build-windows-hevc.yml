name: Build Windows Binaries with HEVC

on:
  workflow_dispatch:
    inputs:
      variant:
        description: 'Build variant (vips-web or vips-all)'
        required: true
        default: 'vips-web'
        type: choice
        options:
          - vips-web
          - vips-all
      with_hevc:
        description: 'Build with HEVC support'
        required: false
        default: false
        type: boolean
      target:
        description: 'Specific target (leave empty for all)'
        required: false
        default: ''
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: libvips/build-win64-mxe
          path: build-win64-mxe

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Patch build.sh (remove contains_gpl_libs checks)
        working-directory: build-win64-mxe
        run: |
          set -euo pipefail
          python3 - <<'PY'
          from pathlib import Path
          import re

          p = Path("build.sh")
          s = p.read_text(encoding="utf-8")
          orig = s

          # 1) Remove the contains_gpl_libs assignment line
          s = re.sub(
              r'^\[ "\$with_hevc" = true \] && contains_gpl_libs=.*\n',
              "",
              s,
              flags=re.M,
          )

          # 2) Remove contains_gpl_libs from default target selection.
          #    Keep the --with-ffi-compat behaviour; otherwise default to both shared+static.
          s = re.sub(
              r'if \[ \${#mxe_targets\[@\]} -eq 0 \]; then\n'
              r'  if \[ "\$contains_gpl_libs" = true \]; then\n'
              r'(?:.|\n)*?'
              r'  fi\n'
              r'fi\n',
              "if [ ${#mxe_targets[@]} -eq 0 ]; then\n"
              "  if [ \"$with_ffi_compat\" = true ]; then\n"
              "    # Omit shared builds by default for the --with-ffi-compat option\n"
              "    mxe_targets=({x86_64,i686,aarch64}-w64-mingw32.static)\n"
              "  else\n"
              "    # Default to all possible targets otherwise\n"
              "    mxe_targets=({x86_64,i686,aarch64}-w64-mingw32.{shared,static})\n"
              "  fi\n"
              "fi\n",
              s,
          )

          # 3) Remove the hard error that blocks static targets when contains_gpl_libs is true
          s = re.sub(
              r'if \[ "\$targets_static" = true \] && \[ "\$contains_gpl_libs" = true \]; then\n'
              r'(?:.|\n)*?'
              r'fi\n',
              "",
              s,
          )

          if s == orig:
              print("No contains_gpl_libs sections found to patch in build.sh; continuing.")
          else:
              p.write_text(s, encoding="utf-8")
              print("Patched build.sh to remove contains_gpl_libs checks.")

          # If build.sh still references contains_gpl_libs, fail fast so we don't silently keep gating.
          if "contains_gpl_libs" in p.read_text(encoding="utf-8"):
              raise SystemExit("build.sh still contains 'contains_gpl_libs' after patch; refusing to continue.")
          PY

      - name: Patch x265 HEVC plugin test source
        if: ${{ inputs.with_hevc }}
        working-directory: build-win64-mxe
        run: |
          set -euo pipefail
          mkdir -p build/plugins/hevc-deps/src
          cat > build/plugins/hevc-deps/src/x265-test.c <<'EOF'
          #include <x265.h>
          
          int main(void) {
            const x265_api *api = x265_api_get(8);
            return api ? 0 : 1;
          }
          EOF
          
          python3 - <<'PY'
          from pathlib import Path
          
          mk = Path("build/plugins/hevc-deps/x265.mk")
          s = mk.read_text(encoding="utf-8")
          s2 = s.replace(
              "'$(TOP_DIR)/src/$(PKG)-test.c'",
              "'/data/plugins/hevc-deps/src/$(PKG)-test.c'",
          )
          if s == s2:
            print("x265.mk did not reference $(TOP_DIR)/src/$(PKG)-test.c; skipping patch.")
          else:
            mk.write_text(s2, encoding="utf-8")
            print("Patched x265.mk to compile test from plugin src/")
          PY

      - name: Patch cfitsio download URL (avoid flaky upstream)
        working-directory: build-win64-mxe
        run: |
          set -euo pipefail
          
          python3 - <<'PY'
          from pathlib import Path
          import re
          
          TARGET_VERSION = "4.6.2"
          
          def comment_out_assignment(text: str, key: str) -> str:
            # Match un-commented assignment lines like:
            #   cfitsio_URL      := ...
            #   cfitsio_CHECKSUM := ...
            # while preserving indentation and any trailing inline comments.
            pattern = (
              rf"^(\s*)(?!#)({re.escape(key)}\b\s*(?:(?::|\+|\?)?=)\s*.*?)(\s*(?:#.*)?)$"
            )
            return re.sub(pattern, r"\1# \2\3", text, flags=re.M)
          
          # Prefer the known location in build-win64-mxe, but fall back to scanning
          # if the layout changes upstream.
          preferred = Path("build/overrides.mk")
          if preferred.exists():
            candidates = [preferred]
          else:
            candidates = list(Path(".").rglob("overrides.mk")) + list(Path(".").rglob("*.mk"))
          
          touched = []
          matched = []
          
          for mk in candidates:
            s = mk.read_text(encoding="utf-8")
            if "cfitsio_" not in s and "cfitsio" not in s:
              continue
          
            # Accept :=, =, ?=, += and tolerate trailing comments.
            m = re.search(
              r"^\\s*cfitsio_VERSION\\s*(?:(?::|\\+|\\?)?=)\\s*([^\\s#]+)\\s*(?:#.*)?$",
              s,
              flags=re.M,
            )
            if not m:
              continue
            if m.group(1) != TARGET_VERSION:
              continue
          
            matched.append(str(mk))
            s2 = s
            # Comment out URL and checksum overrides to fall back to upstream defaults.
            s2 = comment_out_assignment(s2, "cfitsio_URL")
            s2 = comment_out_assignment(s2, "cfitsio_CHECKSUM")
          
            if s2 != s:
              mk.write_text(s2, encoding="utf-8")
              touched.append(str(mk))
          
          if touched:
            print("Patched cfitsio download settings in:")
            for p in touched:
              print(f" - {p}")
          elif matched:
            print("Found cfitsio 4.6.2 definitions, but no changes were needed in:")
            for p in matched:
              print(f" - {p}")
          else:
            msg = "No cfitsio 4.6.2 definitions found to patch."
            if preferred.exists():
              msg += f" (Checked {preferred})"
            else:
              msg += " (Searched for overrides.mk / *.mk)"
            print(msg)
          PY

      - name: Build Windows binaries
        working-directory: build-win64-mxe
        run: |
          chmod +x build.sh
          
          # Build command with optional flags
          BUILD_CMD="./build.sh"
          
          if [ "${{ inputs.with_hevc }}" = "true" ]; then
            BUILD_CMD="$BUILD_CMD --with-hevc"
          fi
          
          if [ -n "${{ inputs.target }}" ]; then
            BUILD_CMD="$BUILD_CMD --target ${{ inputs.target }}"
          fi
          
          BUILD_CMD="$BUILD_CMD ${{ inputs.variant }}"
          
          echo "Running: $BUILD_CMD"
          $BUILD_CMD

      - name: List built artifacts
        working-directory: build-win64-mxe
        run: |
          echo "Built artifacts:"
          ls -lh packaging/*.zip || echo "No zip files found"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries-${{ inputs.variant }}-${{ inputs.with_hevc && 'hevc' || 'no-hevc' }}
          path: build-win64-mxe/packaging/*.zip
          retention-days: 30
          if-no-files-found: error
